{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "Deploys Microsoft Sentinel with Log Analytics Workspace",
    "author": "Azure Sentinel Deployment Script"
  },
  "parameters": {
    "resourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Resource Group to create"
      }
    },
    "workspaceName": {
      "type": "string",
      "defaultValue": "[concat('sentinel-workspace-', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Name of the Log Analytics workspace for Sentinel"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "allowedValues": [
        "eastus",
        "eastus2", 
        "westus",
        "westus2",
        "centralus",
        "northcentralus",
        "southcentralus",
        "westcentralus",
        "canadacentral",
        "canadaeast",
        "brazilsouth",
        "northeurope",
        "westeurope",
        "uksouth",
        "ukwest",
        "francecentral",
        "germanywestcentral",
        "switzerlandnorth",
        "norwayeast",
        "australiaeast",
        "australiasoutheast",
        "japaneast",
        "japanwest",
        "koreacentral",
        "southeastasia",
        "eastasia",
        "centralindia",
        "southafricanorth",
        "East US",
        "East US 2",
        "West US",
        "West US 2",
        "Central US",
        "North Central US",
        "South Central US",
        "West Central US",
        "Canada Central",
        "Canada East",
        "Brazil South",
        "North Europe",
        "West Europe",
        "UK South",
        "UK West",
        "France Central",
        "Germany West Central",
        "Switzerland North",
        "Norway East",
        "Australia East",
        "Australia Southeast",
        "Japan East",
        "Japan West",
        "Korea Central",
        "Southeast Asia",
        "East Asia",
        "India Central",
        "South Africa North"
      ],
      "metadata": {
        "description": "Azure region for all resources (accepts both display names and API names)"
      }
    },
    "dataRetentionDays": {
      "type": "int",
      "defaultValue": 30,
      "minValue": 30,
      "maxValue": 730,
      "metadata": {
        "description": "Number of days to retain data in Log Analytics (30-730 days)"
      }
    },
    "enableSentinel": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable Microsoft Sentinel on the workspace"
      }
    }
  },
  "variables": {
    "logAnalyticsWorkspaceName": "[parameters('workspaceName')]",
    "pricingTier": "PerGB2018",
    "locationMap": {
      "eastus": "eastus",
      "eastus2": "eastus2",
      "westus": "westus", 
      "westus2": "westus2",
      "centralus": "centralus",
      "northcentralus": "northcentralus",
      "southcentralus": "southcentralus",
      "westcentralus": "westcentralus",
      "canadacentral": "canadacentral",
      "canadaeast": "canadaeast",
      "brazilsouth": "brazilsouth",
      "northeurope": "northeurope",
      "westeurope": "westeurope",
      "uksouth": "uksouth",
      "ukwest": "ukwest",
      "francecentral": "francecentral",
      "germanywestcentral": "germanywestcentral",
      "switzerlandnorth": "switzerlandnorth",
      "norwayeast": "norwayeast",
      "australiaeast": "australiaeast",
      "australiasoutheast": "australiasoutheast",
      "japaneast": "japaneast",
      "japanwest": "japanwest",
      "koreacentral": "koreacentral",
      "southeastasia": "southeastasia",
      "eastasia": "eastasia",
      "centralindia": "centralindia",
      "southafricanorth": "southafricanorth",
      "East US": "eastus",
      "East US 2": "eastus2",
      "West US": "westus",
      "West US 2": "westus2",
      "Central US": "centralus",
      "North Central US": "northcentralus",
      "South Central US": "southcentralus",
      "West Central US": "westcentralus",
      "Canada Central": "canadacentral",
      "Canada East": "canadaeast",
      "Brazil South": "brazilsouth",
      "North Europe": "northeurope",
      "West Europe": "westeurope",
      "UK South": "uksouth",
      "UK West": "ukwest",
      "France Central": "francecentral",
      "Germany West Central": "germanywestcentral",
      "Switzerland North": "switzerlandnorth",
      "Norway East": "norwayeast",
      "Australia East": "australiaeast",
      "Australia Southeast": "australiasoutheast",
      "Japan East": "japaneast",
      "Japan West": "japanwest",
      "Korea Central": "koreacentral",
      "Southeast Asia": "southeastasia",
      "East Asia": "eastasia",
      "India Central": "centralindia",
      "South Africa North": "southafricanorth"
    },
    "normalizedLocation": "[variables('locationMap')[parameters('location')]]"
  },
  "resources": [
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('logAnalyticsWorkspaceName')]",
      "location": "[variables('normalizedLocation')]",
      "tags": {
        "Purpose": "Microsoft Sentinel",
        "Environment": "Production",
        "CreatedBy": "Sentinel Deployment Script"
      },
      "properties": {
        "sku": {
          "name": "[variables('pricingTier')]"
        },
        "retentionInDays": "[parameters('dataRetentionDays')]",
        "features": {
          "searchVersion": 1,
          "legacy": 0,
          "enableLogAccessUsingOnlyResourcePermissions": true,
          "disableLocalAuth": false
        },
        "workspaceCapping": {
          "dailyQuotaGb": -1
        },
        "publicNetworkAccessForIngestion": "Enabled",
        "publicNetworkAccessForQuery": "Enabled"
      }
    },
    {
      "condition": "[parameters('enableSentinel')]",
      "type": "Microsoft.SecurityInsights/onboardingStates",
      "apiVersion": "2023-02-01",
      "scope": "[concat('Microsoft.OperationalInsights/workspaces/', variables('logAnalyticsWorkspaceName'))]",
      "name": "default",
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
      ],
      "properties": {
        "customerManagedKey": false
      }
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[resourceGroup().name]"
    },
    "workspaceResourceId": {
      "type": "string",
      "value": "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
    },
    "workspaceName": {
      "type": "string",
      "value": "[variables('logAnalyticsWorkspaceName')]"
    },
    "workspaceId": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName')), '2022-10-01').customerId]"
    },
    "location": {
      "type": "string",
      "value": "[parameters('location')]"
    },
    "pricingTier": {
      "type": "string",
      "value": "[variables('pricingTier')]"
    },
    "sentinelPortalUrl": {
      "type": "string",
      "value": "[concat('https://portal.azure.com/#view/Microsoft_Azure_Security_Insights/MainMenuBlade/~/0/subscriptionId/', subscription().subscriptionId, '/resourceGroup/', resourceGroup().name)]"
    }
  }
}
